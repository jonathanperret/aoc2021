~library/macros.tal
~library/devices.tal

( variables )

|0000

|0100 @program

  T< "parse-scanner: >T
  S< "--- 20 "scanner 20 "0 20 "--- 0a
     "-1,-1,1 0a
     "-2,-2,2 0a
     "-3,-3,3 0a
     "-2,-3,1 0a
     "5,6,-4 0a
     "8,0,7 0a
     0a >S ;test-scanner-parse JSR2
  ( EXPECT 6 beacons found )
  ( EXPECT -3 -3 3 )
  ( EXPECT -2 -3 1 )
  ( EXPECT -2 -2 2 )
  ( EXPECT -1 -1 1 )
  ( EXPECT 5 6 -4 )
  ( EXPECT 8 0 7 )

  T< "parse-scanner-eof: >T
  S< >S ;test-scanner-parse JSR2
  ( EXPECT 0 beacons found )

  T< "parse-scanners: >T
  S< "--- 20 "scanner 20 "0 20 "--- 0a
     "-1,-1,1 0a
     "-2,-2,2 0a
     0a
     "--- 20 "scanner 20 "1 20 "--- 0a
     "4,5,6 0a
     "7,8,9 0a
     0a >S ;test-scanners-parse JSR2
  ( EXPECT 2 scanners found )
  ( EXPECT 0: )
  ( EXPECT -2 -2 2 )
  ( EXPECT -1 -1 1 )
  ( EXPECT 1: )
  ( EXPECT 4 5 6 )
  ( EXPECT 7 8 9 )

  T< "vector3-equal >T
  S< 0101 0102 0103 >S S< 0101 0102 0103 >S ;vector3/equal JSR2 DBGBYTE POP ( EXPECT 0x01 )
  S< 0101 0102 0103 >S S< 0101 0102 0104 >S ;vector3/equal JSR2 DBGBYTE POP ( EXPECT 0x00 )

  T< "vector3-lessthan >T
  S< 0101 0102 0103 >S S< 0201 0202 0203 >S ;test-vector3-lessthan JSR2
  ( EXPECT 257 258 259 < 513 514 515 )
  ( EXPECT 513 514 515 â‰¥ 257 258 259 )

  S< 0101 0102 0103 >S S< 0101 0202 0203 >S ;test-vector3-lessthan JSR2
  ( EXPECT 257 258 259 < 257 514 515 )
  ( EXPECT 257 514 515 â‰¥ 257 258 259 )

  S< 0101 0102 0103 >S S< 0101 0102 0203 >S ;test-vector3-lessthan JSR2
  ( EXPECT 257 258 259 < 257 258 515 )
  ( EXPECT 257 258 515 â‰¥ 257 258 259 )

  S< 0101 0102 0103 >S S< 0101 0102 0103 >S ;test-vector3-lessthan JSR2
  ( EXPECT 257 258 259 â‰¥ 257 258 259 )
  ( EXPECT 257 258 259 â‰¥ 257 258 259 )

  S< ffff ffff ffff >S S< 0101 0102 0103 >S ;test-vector3-lessthan JSR2
  ( EXPECT -1 -1 -1 < 257 258 259 )
  ( EXPECT 257 258 259 â‰¥ -1 -1 -1 )

  T< "beacon-insert-empty-list: >T
  S< 8080 ffff ffff ffff >S DUP2 S< 0101 0102 0103 >S ;scanner/insert JSR2 ;scanner/dump JSR2
  ( EXPECT 257 258 259 )

  T< "beacon-insert-at-end: >T
  S< 0101 0102 0103 8080 ffff ffff ffff >S DUP2 S< 0101 0102 0104 >S ;scanner/insert JSR2 ;scanner/dump JSR2
  ( EXPECT 257 258 259 )
  ( EXPECT 257 258 260 )

  T< "beacon-insert-at-start: >T
  S< 0101 0102 0103 0101 0102 0104 8080 ffff ffff ffff >S DUP2 S< 0101 0102 0102 >S ;scanner/insert JSR2 ;scanner/dump JSR2
  ( EXPECT 257 258 258 )
  ( EXPECT 257 258 259 )
  ( EXPECT 257 258 260 )

  T< "beacon-insert-middle: >T
  S< 0101 0102 0102 0101 0102 0104 8080 ffff ffff ffff >S DUP2 S< 0101 0102 0103 >S ;scanner/insert JSR2 ;scanner/dump JSR2
  ( EXPECT 257 258 258 )
  ( EXPECT 257 258 259 )
  ( EXPECT 257 258 260 )

  T< "beacon-insert-skipdups: >T
  S< 0101 0102 0103 8080 ffff ffff ffff >S DUP2 S< 0101 0102 0103 >S ;scanner/insert JSR2 ;scanner/dump JSR2
  ( EXPECT 257 258 259 )

  T< "+y+z+x >T
  S< 8080 8080 8080 >S DUP2 S< 0101 0102 0103 >S ;rotations/+Y+Z+X JSR2 ;vector3/print JSR2 LF
  ( EXPECT 258 259 257 )

  T< "+x-y-z >T
  S< 8080 8080 8080 >S DUP2 S< 0101 0102 0103 >S ;rotations/+X-Y-Z JSR2 ;vector3/print JSR2 LF
  ( EXPECT 257 -258 -259 )

  T< "rotation-get: >T
  S< 8080 8080 8080 >S DUP2 S< 0101 0102 0103 >S #0017 ;rotations/get JSR2 JSR2 ;vector3/print JSR2 LF
  ( EXPECT -259 -258 -257 )

  T< "scanner-rotate: >T
  ;&sctmp S< 0101 0102 0103 0101 0102 0104 8080 >S #0017 ( -Z-Y-X ) ;scanner/rotate JSR2
  ;&sctmp ;scanner/dump JSR2
  ( EXPECT -260 -258 -257 )
  ( EXPECT -259 -258 -257 )

  T< "scanner-translate: >T
  ;&sctmp S< 0101 0102 0103 0101 0102 0104 8080 >S S< ff01 ff01 ff01 >S ;scanner/translate JSR2
  ;&sctmp ;scanner/dump JSR2
  ( EXPECT 2 3 4 )
  ( EXPECT 2 3 5 )

  T< "scanner-count-matches: >T
  S< "-0- 0a
     "-1,-1,1 0a
     "-1,30,2 0a
     "-1,-1,2 0a
     "-7,8,2 0a >S
  S< "-1- 0a
     "0,0,0 0a
     "-1,-1,1 0a
     "-1,-1,2 0a
     "-1,30,2 0a
     "5,-1,2 0a
     "-5,-1,40 0a
     "-2,-2,2 0a >S ;test-scanner-count-matches JSR2
  ( EXPECT 3 matches found )

  T< "ðŸŽ„ >T
  BRK !

|0800
  [ &sctmp $100 ]
|1000

( v1* v2* -- )
@test-vector3-lessthan
  DUP4 ,&test-compare JSR
  SWP2 ,&test-compare JSR
  RTN

  ( v1* v2* -- )
  &test-compare
    DUP4 ;vector3/less-than JSR2 STH
    SWP2 ;vector3/print JSR2 SP
    STHr ;&print-comparison JSR2 SP
    ;vector3/print JSR2 LF
    RTN

  ( <? )
  &print-comparison
    ,&is-less JCN
    P< "â‰¥ >P
    RTN
    &is-less
    LIT '< EMIT
    RTN

( s* -- )
@test-scanner-parse
  ;make-get-byte JSR2 ;&sc1 ;scanner/parse JSR2
  DBGBYTEDECn P< 20 "beacons 20 "found >P LF
  #00 EQU ,&not-parsed JCN
    ;&sc1 ;scanner/dump JSR2
  &not-parsed
  RTN
  [ &sc1 $a0 ]

( s* -- )
@test-scanners-parse
  ;make-get-byte JSR2 ;scanners/parse JSR2
  [ ;scanners/count LDA2 ] DBGSHORTDECn P< 20 "scanners 20 "found >P LF POP2
  ;scanners/dump JSR2
  RTN

( s1* s2* -- )
@test-scanner-count-matches
  ;make-get-byte JSR2 ;&sc1 ;scanner/parse JSR2 POP
  ;make-get-byte JSR2 ;&sc2 ;scanner/parse JSR2 POP
  ;&sc1 ;&sc2 ;scanner/count-matches JSR2
  DBGSHORTDECn POP2 P< 20 "matches 20 "found >P LF
  RTN
  [ &sc1 $100 &sc2 $100 ]

( s* -- get-byte )
@make-get-byte
  ;input STA2
  ;get-byte-from-input
  RTN

( -- b )
@get-byte-from-input
  [ ;input LDA2 ] LDA STH
  [ ;input LDA2 ] INC2 [ ;input STA2 ]
  STHr
  RTN

@input $2

~library/test.tal
~day19_lib.tal
