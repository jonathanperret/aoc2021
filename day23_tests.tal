~library/macros.tal
~library/devices.tal
~day23_macros.tal

( variables )

|0000

|0100 @program

  T< "parse: >T
  S<     "############# 0a
         "#...........# 0a
         "###B#C#B#D### 0a
     20 20 "#A#D#C#A# 0a
     20 20 "######### 0a >S ;test-parse JSR2
  ( EXPECT 0 )
  ( EXPECT â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” )
  ( EXPECT â”‚@@.@.@.@.@@â”‚ )
  ( EXPECT â””â”€â”Bâ”‚Câ”‚Bâ”‚Dâ”Œâ”€â”˜ )
  ( EXPECT   â”‚@â”‚Dâ”‚@â”‚Aâ”‚   )
  ( EXPECT   â””â”€â”€â”€â”€â”€â”€â”€â”˜   )

  T< "stack/push: >T
  ;statestack/init JSR2
  ;t/state1 ;statestack/push JSR2
  ;t/state2 ;statestack/push JSR2
  ;t/state1 ;statestack/push JSR2
  ;statestack/dump JSR2
  ( EXPECT 0: 0 )
  ( EXPECT â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” )
  ( EXPECT â”‚@@.@.@.@.@@â”‚ )
  ( EXPECT â””â”€â”Bâ”‚Câ”‚Bâ”‚Dâ”Œâ”€â”˜ )
  ( EXPECT   â”‚@â”‚Dâ”‚@â”‚Aâ”‚   )
  ( EXPECT   â””â”€â”€â”€â”€â”€â”€â”€â”˜   )

  ( EXPECT 1: 0 )
  ( EXPECT â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” )
  ( EXPECT â”‚@@.@.@.@.@@â”‚ )
  ( EXPECT â””â”€â”@â”‚@â”‚@â”‚@â”Œâ”€â”˜ )
  ( EXPECT   â”‚@â”‚@â”‚@â”‚@â”‚   )
  ( EXPECT   â””â”€â”€â”€â”€â”€â”€â”€â”˜   )

  ( EXPECT 2: 0 )
  ( EXPECT â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” )
  ( EXPECT â”‚@@.@.@.@.@@â”‚ )
  ( EXPECT â””â”€â”Bâ”‚Câ”‚Bâ”‚Dâ”Œâ”€â”˜ )
  ( EXPECT   â”‚@â”‚Dâ”‚@â”‚Aâ”‚   )
  ( EXPECT   â””â”€â”€â”€â”€â”€â”€â”€â”˜   )

  T< "stack/pop: >T
  ;t/state2 ;statestack/pop JSR2
  ;t/state2 ;state/dump JSR2
  ( EXPECT 0 )
  ( EXPECT â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” )
  ( EXPECT â”‚@@.@.@.@.@@â”‚ )
  ( EXPECT â””â”€â”Bâ”‚Câ”‚Bâ”‚Dâ”Œâ”€â”˜ )
  ( EXPECT   â”‚@â”‚Dâ”‚@â”‚Aâ”‚   )
  ( EXPECT   â””â”€â”€â”€â”€â”€â”€â”€â”˜   )

  T< "player/process-moves: >T
  ;statestack/init JSR2
  #0064 ;t/state1 STATE>cost STA2
  ;t/state1 ;statestack/push JSR2
  ;player/init JSR2
  ;player/load-top-state JSR2
  ;player/process-moves JSR2
  ;statestack/size JSR2 ;print-short-decimal JSR2 LF
  ( EXPECT 28 )
  #0000 #0013 DO ;t/state2 ;statestack/pop JSR2 LOOP
  ;statestack/dump JSR2
  ( EXPECT 0: 1100 )
  ( EXPECT â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” )
  ( EXPECT â”‚@C.@.@.@.@@â”‚ )
  ( EXPECT â””â”€â”Bâ”‚Dâ”‚Bâ”‚Dâ”Œâ”€â”˜ )
  ( EXPECT   â”‚@â”‚@â”‚@â”‚Aâ”‚   )
  ( EXPECT   â””â”€â”€â”€â”€â”€â”€â”€â”˜   )
  ( EXPECT 1: 1300 )
  ( EXPECT â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” )
  ( EXPECT â”‚C@.@.@.@.@@â”‚ )
  ( EXPECT â””â”€â”Bâ”‚Dâ”‚Bâ”‚Dâ”Œâ”€â”˜ )
  ( EXPECT   â”‚@â”‚@â”‚@â”‚Aâ”‚   )
  ( EXPECT   â””â”€â”€â”€â”€â”€â”€â”€â”˜   )
  ( EXPECT 2: 260 )
  ( EXPECT â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” )
  ( EXPECT â”‚@@.@.@.@.@Bâ”‚ )
  ( EXPECT â””â”€â”@â”‚Câ”‚Bâ”‚Dâ”Œâ”€â”˜ )
  ( EXPECT   â”‚@â”‚Dâ”‚@â”‚Aâ”‚   )
  ( EXPECT   â””â”€â”€â”€â”€â”€â”€â”€â”˜   )
  ( EXPECT 3: 240 )
  ( EXPECT â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” )
  ( EXPECT â”‚@@.@.@.@.B@â”‚ )
  ( EXPECT â””â”€â”@â”‚Câ”‚Bâ”‚Dâ”Œâ”€â”˜ )
  ( EXPECT   â”‚@â”‚Dâ”‚@â”‚Aâ”‚   )
  ( EXPECT   â””â”€â”€â”€â”€â”€â”€â”€â”˜   )
  ( EXPECT 4: 200 )
  ( EXPECT â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” )
  ( EXPECT â”‚@@.@.@.B.@@â”‚ )
  ( EXPECT â””â”€â”@â”‚Câ”‚Bâ”‚Dâ”Œâ”€â”˜ )
  ( EXPECT   â”‚@â”‚Dâ”‚@â”‚Aâ”‚   )
  ( EXPECT   â””â”€â”€â”€â”€â”€â”€â”€â”˜   )
  ( EXPECT 5: 160 )
  ( EXPECT â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” )
  ( EXPECT â”‚@@.@.B.@.@@â”‚ )
  ( EXPECT â””â”€â”@â”‚Câ”‚Bâ”‚Dâ”Œâ”€â”˜ )
  ( EXPECT   â”‚@â”‚Dâ”‚@â”‚Aâ”‚   )
  ( EXPECT   â””â”€â”€â”€â”€â”€â”€â”€â”˜   )
  ( EXPECT 6: 140 )
  ( EXPECT â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” )
  ( EXPECT â”‚@@.B.@.@.@@â”‚ )
  ( EXPECT â””â”€â”@â”‚Câ”‚Bâ”‚Dâ”Œâ”€â”˜ )
  ( EXPECT   â”‚@â”‚Dâ”‚@â”‚Aâ”‚   )
  ( EXPECT   â””â”€â”€â”€â”€â”€â”€â”€â”˜   )
  ( EXPECT 7: 160 )
  ( EXPECT â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” )
  ( EXPECT â”‚@B.@.@.@.@@â”‚ )
  ( EXPECT â””â”€â”@â”‚Câ”‚Bâ”‚Dâ”Œâ”€â”˜ )
  ( EXPECT   â”‚@â”‚Dâ”‚@â”‚Aâ”‚   )
  ( EXPECT   â””â”€â”€â”€â”€â”€â”€â”€â”˜   )
  ( EXPECT 8: 180 )
  ( EXPECT â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” )
  ( EXPECT â”‚B@.@.@.@.@@â”‚ )
  ( EXPECT â””â”€â”@â”‚Câ”‚Bâ”‚Dâ”Œâ”€â”˜ )
  ( EXPECT   â”‚@â”‚Dâ”‚@â”‚Aâ”‚   )
  ( EXPECT   â””â”€â”€â”€â”€â”€â”€â”€â”˜   )

  T< "player/process-exits: >T
  ;t/mid-state ;state/dump JSR2
  ( EXPECT 16 )
  ( EXPECT â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” )
  ( EXPECT â”‚B@.@.D.A.DDâ”‚ )
  ( EXPECT â””â”€â”Dâ”‚@â”‚@â”‚@â”Œâ”€â”˜ )
  ( EXPECT   â”‚@â”‚@â”‚@â”‚@â”‚   )
  ( EXPECT   â””â”€â”€â”€â”€â”€â”€â”€â”˜   )
  ;statestack/init JSR2
  ;t/mid-state ;statestack/push JSR2
  ;player/init JSR2
  ;player/load-top-state JSR2
  ;player/process-exits JSR2
  ;player/srcstate ;state/dump JSR2
  ( EXPECT 16 )
  ( EXPECT â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” )
  ( EXPECT â”‚@@.@.D.A.@@â”‚ )
  ( EXPECT â””â”€â”Dâ”‚@â”‚@â”‚@â”Œâ”€â”˜ )
  ( EXPECT   â”‚@â”‚@â”‚@â”‚@â”‚   )
  ( EXPECT   â””â”€â”€â”€â”€â”€â”€â”€â”˜   )

  T< "player: >T
  ;t/mid-state ;state/dump JSR2
  ( EXPECT 16 )
  ( EXPECT â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” )
  ( EXPECT â”‚B@.@.D.A.DDâ”‚ )
  ( EXPECT â””â”€â”Dâ”‚@â”‚@â”‚@â”Œâ”€â”˜ )
  ( EXPECT   â”‚@â”‚@â”‚@â”‚@â”‚   )
  ( EXPECT   â””â”€â”€â”€â”€â”€â”€â”€â”˜   )
  ;statestack/init JSR2
  ;t/mid-state ;statestack/push JSR2
  ;player/init JSR2
  ;player/next JSR2
  ;statestack/dump JSR2
  ( EXPECT 0: 8016 )
  ( EXPECT â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” )
  ( EXPECT â”‚@@.D.D.A.@@â”‚ )
  ( EXPECT â””â”€â”@â”‚@â”‚@â”‚@â”Œâ”€â”˜ )
  ( EXPECT   â”‚@â”‚@â”‚@â”‚@â”‚   )
  ( EXPECT   â””â”€â”€â”€â”€â”€â”€â”€â”˜   )
  ( EXPECT 1: 10016 )
  ( EXPECT â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” )
  ( EXPECT â”‚@D.@.D.A.@@â”‚ )
  ( EXPECT â””â”€â”@â”‚@â”‚@â”‚@â”Œâ”€â”˜ )
  ( EXPECT   â”‚@â”‚@â”‚@â”‚@â”‚   )
  ( EXPECT   â””â”€â”€â”€â”€â”€â”€â”€â”˜   )
  ( EXPECT 2: 12016 )
  ( EXPECT â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” )
  ( EXPECT â”‚D@.@.D.A.@@â”‚ )
  ( EXPECT â””â”€â”@â”‚@â”‚@â”‚@â”Œâ”€â”˜ )
  ( EXPECT   â”‚@â”‚@â”‚@â”‚@â”‚   )
  ( EXPECT   â””â”€â”€â”€â”€â”€â”€â”€â”˜   )

  T< "player/check-goal: >T
  ;t/end-state ;state/dump JSR2
  ( EXPECT 1000 )
  ( EXPECT â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” )
  ( EXPECT â”‚A@.@.@.@.@@â”‚ )
  ( EXPECT â””â”€â”@â”‚@â”‚@â”‚@â”Œâ”€â”˜ )
  ( EXPECT   â”‚@â”‚@â”‚@â”‚@â”‚   )
  ( EXPECT   â””â”€â”€â”€â”€â”€â”€â”€â”˜   )
  ;statestack/init JSR2
  ;t/end-state ;statestack/push JSR2
  ;player/next JSR2
  ( EXPECT goal: 1000 )
  [ ;player/cost-limit LDA2 ] ;print-short-decimal JSR2 LF
  ( EXPECT 1000 )

  T< "player/cost-limit: >T
  ;statestack/init JSR2
  #0064 ;t/state1 STATE>cost STA2
  ;t/state1 ;state/dump JSR2
  ( EXPECT 100 )
  ( EXPECT â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” )
  ( EXPECT â”‚@@.@.@.@.@@â”‚ )
  ( EXPECT â””â”€â”Bâ”‚Câ”‚Bâ”‚Dâ”Œâ”€â”˜ )
  ( EXPECT   â”‚@â”‚Dâ”‚@â”‚Aâ”‚   )
  ( EXPECT   â””â”€â”€â”€â”€â”€â”€â”€â”˜   )
  ;t/state1 ;statestack/push JSR2
  #009f [ ;player/cost-limit STA2 ]
  ;player/load-top-state JSR2
  ;player/process-moves JSR2
  ;statestack/dump JSR2
  ( EXPECT 0: 140 )
  ( EXPECT â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” )
  ( EXPECT â”‚@@.@.B.@.@@â”‚ )
  ( EXPECT â””â”€â”Bâ”‚Câ”‚@â”‚Dâ”Œâ”€â”˜ )
  ( EXPECT   â”‚@â”‚Dâ”‚@â”‚Aâ”‚   )
  ( EXPECT   â””â”€â”€â”€â”€â”€â”€â”€â”˜   )
  ( EXPECT 1: 140 )
  ( EXPECT â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” )
  ( EXPECT â”‚@@.B.@.@.@@â”‚ )
  ( EXPECT â””â”€â”@â”‚Câ”‚Bâ”‚Dâ”Œâ”€â”˜ )
  ( EXPECT   â”‚@â”‚Dâ”‚@â”‚Aâ”‚   )
  ( EXPECT   â””â”€â”€â”€â”€â”€â”€â”€â”˜   )

  T< "state/fixed-cost: >T
  ;t/state1 ;state/compute-fixed-cost JSR2
  ;t/state1 ;state/dump JSR2
  ( EXPECT 2011 )
  ( EXPECT â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” )
  ( EXPECT â”‚@@.@.@.@.@@â”‚ )
  ( EXPECT â””â”€â”Bâ”‚Câ”‚Bâ”‚Dâ”Œâ”€â”˜ )
  ( EXPECT   â”‚@â”‚Dâ”‚@â”‚Aâ”‚   )
  ( EXPECT   â””â”€â”€â”€â”€â”€â”€â”€â”˜   )

  T< "ğŸ‘ >T
  BRK !

( s* -- )
@test-parse
  ;make-get-byte JSR2 ;t/state1 ;state/parse JSR2
  ;t/state1 ;state/dump JSR2
  RTN

( s* -- get-byte )
@make-get-byte
  ;t/input STA2
  ;get-byte-from-input
  RTN

( -- b )
@get-byte-from-input
  [ ;t/input LDA2 ] LDA STH
  [ ;t/input *INC2 ]
  STHr
  RTN

@t
  [ &input $2 &state1 STATEPAD &state2 STATEPAD 
    &mid-state
      04 00
      00 00
      00 00
      00 00
      02 00 00 04 01 04 04
      0010
    &end-state
      00 00
      00 00
      00 00
      00 00
      01 00 00 00 00 00 00
      03e8
    ]

~library/test.tal
~day23_lib.tal
